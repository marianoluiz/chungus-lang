// ─────────── START ───────────

start: program

program: (function_statement)* general_statement general_statement_tail

// ─────────── FUNCTIONS ───────────

function_statement: FN ID "(" arg_list_opt ")" local_statement return_opt CLOSE

arg_list_opt: arg_list
            | 

arg_list: arg_element arg_element_tail

arg_element_tail: "," arg_element arg_element_tail
                | 

arg_element: expr

return_opt: return_statement
          | 

return_statement: RET expr

// ─────────── STATEMENTS ───────────

local_statement: general_statement local_statement_tail

local_statement_tail: general_statement local_statement_tail
                    | 

general_statement_tail: general_statement general_statement_tail
                      | 

general_statement: ID id_statement_tail
                 | output_statement
                 | control_structure_statement
                 | error_handling_statement
                 | todo_statement
                 | array_manip_statement

// ─────────── ID STATEMENTS ───────────

id_statement_tail: unary_statement
                 | assignment_statement
                 | function_call_statement
                 | "[" index "]" index_loop "=" assignment_value


unary_statement: UN_PLUS
               | UN_MINUS

assignment_statement: "=" assignment_value

assignment_value: READ
                | type_casting
                | "[" element_list "]"
                | expr

function_call_statement: "(" arg_list_opt ")"

// ─────────── TYPE CASTING ───────────

type_casting: INT "(" expr ")"
            | FLOAT "(" expr ")"

// ─────────── ARRAY ELEMENTS ───────────

element_list: array_element array_tail
            | 

array_tail: "," array_element array_tail
          | 

array_element: int_float_str_bool_lit
             | ID
             | "[" element_list "]"

int_float_str_bool_lit: int_float_str_lit
                      | TRUE
                      | FALSE

int_float_str_lit: int_float_lit
                 | STR_LITERAL

int_float_lit: INT_LITERAL
             | FLOAT_LITERAL

// ─────────── EXPRESSIONS ───────────

expr: logical_or_expr

logical_or_expr: logical_and_expr logical_or_expr_tail
logical_or_expr_tail: OR logical_and_expr logical_or_expr_tail
                    | 

logical_and_expr: logical_not_expr logical_and_expr_tail
logical_and_expr_tail: AND logical_not_expr logical_and_expr_tail
                     | 

logical_not_expr: NOT eq_expr
                | eq_expr

eq_expr: comp_operand eq_expr_tail

eq_expr_tail: EQ_EQ comp_operand eq_expr_tail
            | NOT_EQ comp_operand eq_expr_tail
            | 

comp_operand: rel_expr
            | STR_LITERAL
            | TRUE
            | FALSE

rel_expr: arith_expr rel_expr_tail

rel_expr_tail: rel_op arith_expr rel_expr_tail
             | 

rel_op: GT | LT | GE | LE

arith_expr: term arith_expr_tail

arith_expr_tail: "+" term arith_expr_tail
               | "-" term arith_expr_tail
               | 

term: factor term_tail

term_tail: "*" factor term_tail
         | "/" factor term_tail
         | FLOORDIV factor term_tail
         | "%" factor term_tail
         | 

factor: power factor_tail

factor_tail: POW factor
           | 

power: int_float_lit
     | ID postfix_tail

postfix_tail: "(" arg_list_opt ")"
            | "[" index "]" index_loop
            | 

index: INT_LITERAL
     | ID

index_loop: "[" index "]" index_loop
          | 

// ─────────── OUTPUT ───────────

output_statement: SHOW output_value

output_value: ID
            | STR_LITERAL

// ─────────── CONTROL STRUCTURES ───────────

control_structure_statement: conditional_statement
                           | looping_statement

conditional_statement: if_block elif_block else_block CLOSE

if_block: IF condition local_statement

elif_block: ELIF condition local_statement elif_block
          | 

else_block: ELSE local_statement
          | 

condition: expr

looping_statement: for_statement
                 | while_statement

for_statement: FOR ID IN range_expression local_statement CLOSE

range_expression: RANGE "(" range_list ")"

range_list: index range_tail_1

range_tail_1: "," index range_tail_2
            | 

range_tail_2: "," index
            | 

while_statement: WHILE condition local_statement CLOSE


// ─────────── ERROR HANDLING ───────────

error_handling_statement: try_block fail_block error_handling_tail CLOSE

try_block: TRY local_statement
fail_block: FAIL local_statement

error_handling_tail: always_block
                   | 

always_block: ALWAYS local_statement

// ─────────── TODO ───────────

todo_statement: TODO

// ─────────── ARRAY MANIPULATION ───────────

array_manip_statement: ARRAY_ADD "(" ID index_loop "," expr ")"
                     | ARRAY_REMOVE "(" ID index_loop "," index ")"



// ─────────── TERMINALS ───────────

AND: /and(?![a-zA-Z0-9_])/
OR: /or(?![a-zA-Z0-9_])/
TRUE: /true(?![a-zA-Z0-9_])/
FALSE: /false(?![a-zA-Z0-9_])/
READ: /read(?![a-zA-Z0-9_])/
SHOW: /show(?![a-zA-Z0-9_])/

IF: /if(?![a-zA-Z0-9_])/
ELIF: /elif(?![a-zA-Z0-9_])/
ELSE: /else(?![a-zA-Z0-9_])/
WHILE: /while(?![a-zA-Z0-9_])/
FOR: /for(?![a-zA-Z0-9_])/
IN: /in(?![a-zA-Z0-9_])/
RANGE: /range(?![a-zA-Z0-9_])/

FN: /fn(?![a-zA-Z0-9_])/
RET: /ret(?![a-zA-Z0-9_])/

TRY: /try(?![a-zA-Z0-9_])/
FAIL: /fail(?![a-zA-Z0-9_])/
ALWAYS: /always(?![a-zA-Z0-9_])/

TODO: /todo(?![a-zA-Z0-9_])/

ARRAY_ADD: /array_add(?![a-zA-Z0-9_])/
ARRAY_REMOVE: /array_remove(?![a-zA-Z0-9_])/

INT: /int(?![a-zA-Z0-9_])/
FLOAT: /float(?![a-zA-Z0-9_])/

CLOSE: /close(?![a-zA-Z0-9_])/

NOT: "!"

UN_PLUS: "++"
UN_MINUS: "--"

FLOORDIV: "//"
POW: "**"

EQ_EQ: "=="
NOT_EQ: "!="
GT: ">"
LT: "<"
GE: ">="
LE: "<="

ID: /(?!(and|or|true|false|read|show|if|elif|else|while|for|in|range|fn|ret|try|fail|always|todo|array_add|array_remove|int|float|close)\b)[a-zA-Z_][a-zA-Z0-9_]*/
INT_LITERAL: /~?[0-9]+/
FLOAT_LITERAL: /~?[0-9]+\.[0-9]+/
STR_LITERAL: /'([^'\\]|\\.)*'/

M_COMMENT: /(?s)###.*?###/
S_COMMENT: /#[^\n]*/

%ignore M_COMMENT
%ignore S_COMMENT

%ignore /[ \t\r\n]+/