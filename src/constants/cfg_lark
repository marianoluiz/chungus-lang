// ─────────── START ───────────

start: program

program: (function_statement)* general_statement general_statement_tail

// ─────────── FUNCTIONS ───────────

function_statement: FN ID "(" param_list_opt ")" ":" local_statement return_opt CLOSE

param_list_opt: param_list
              | 

param_list: ID param_element_tail

param_element_tail: "," ID param_element_tail
                  | 

return_opt: return_statement
          | 

return_statement: RET expr ";"

// ─────────── STATEMENTS ───────────

local_statement: general_statement local_statement_tail

local_statement_tail: general_statement local_statement_tail
                    | 

general_statement: ID id_statement_tail ";"
                 | output_statement ";"
                 | control_structure_statement
                 | error_handling_statement
                 | todo_statement ";"

general_statement_tail: general_statement general_statement_tail
                      | 

// ─────────── ID STATEMENTS ───────────

id_statement_tail: "=" assignment_value
                 | function_call_statement
                 | ":" "[" expr "]" arrays
                 | "[" expr "]" index_loop "=" assignment_value

assignment_value: READ
                | expr

function_call_statement: "(" arg_list_opt ")"


arg_list_opt: arg_list
            | 

arg_list: arg_element arg_element_tail

arg_element_tail: "," arg_element arg_element_tail
                | 

arg_element: expr

// ─────────── ARRAYS DECLARATION ───────────

arrays: one_d_array_init
      | "[" expr "]" two_d_array_init

one_d_array_init: "=" "[" one_d_element_list "]"
two_d_array_init: "=" "[" two_d_element_list "]"

one_d_element_list: array_element one_d_array_tail
                  |

two_d_element_list: two_d_array_element two_d_array_tail
                  |

two_d_array_element: "[" two_d_inner_element_list "]"

two_d_inner_element_list: array_element two_d_inner_tail
                        |

two_d_inner_tail: "," array_element two_d_inner_tail
                |

one_d_array_tail: "," array_element one_d_array_tail
                |

two_d_array_tail: "," two_d_array_element two_d_array_tail
                |

// ─────────── TYPE CASTING ───────────

type_casting: INT "(" expr ")"
            | FLOAT "(" expr ")"

// ─────────── ARRAY ELEMENTS ───────────

array_element: expr


int_float_str_bool_lit: int_float_str_lit
                      | TRUE
                      | FALSE

int_float_str_lit: int_float_lit
                 | STR_LITERAL

int_float_lit: INT_LITERAL
             | FLOAT_LITERAL

// ─────────── EXPRESSIONS ───────────

expr: operand expr_tail

expr_tail: operator operand expr_tail
         |

operand: int_float_str_bool_lit
       | NOT operand
       | "(" expr ")"
       | type_casting
       | ID postfix_tail

postfix_tail: "(" arg_list_opt ")"
            | "[" expr "]" index_loop
            | 

index_loop: "[" expr "]"
          | 

operator: AND | OR | EQ_EQ | NOT_EQ | GT | LT | GE | LE | "+" | "-" | "*" | "/" | POW | FLOORDIV | "%"

// ─────────── OUTPUT ───────────

output_statement: SHOW output_value

output_value: ID
            | STR_LITERAL

// ─────────── CONTROL STRUCTURES ───────────

control_structure_statement: conditional_statement
                           | looping_statement

conditional_statement: if_block elif_block else_block CLOSE

if_block: IF condition ":" local_statement

elif_block: ELIF condition ":" local_statement elif_block
          | 

else_block: ELSE ":" local_statement
          | 

condition: expr

looping_statement: for_statement
                 | while_statement

for_statement: FOR ID IN range_expression ":" local_statement CLOSE

range_expression: RANGE "(" range_list ")"

range_list: expr range_tail_1

range_tail_1: "," expr range_tail_2
            | 

range_tail_2: "," expr
            | 

while_statement: WHILE condition ":" local_statement CLOSE


// ─────────── ERROR HANDLING ───────────

error_handling_statement: try_block fail_block error_handling_tail CLOSE

try_block: TRY ":" local_statement
fail_block: FAIL ":" local_statement

error_handling_tail: always_block
                   | 

always_block: ALWAYS ":" local_statement

// ─────────── TODO ───────────

todo_statement: TODO


// ─────────── TERMINALS ───────────

AND: /and(?![a-zA-Z0-9_])/
OR: /or(?![a-zA-Z0-9_])/
TRUE: /true(?![a-zA-Z0-9_])/
FALSE: /false(?![a-zA-Z0-9_])/
READ: /read(?![a-zA-Z0-9_])/
SHOW: /show(?![a-zA-Z0-9_])/

IF: /if(?![a-zA-Z0-9_])/
ELIF: /elif(?![a-zA-Z0-9_])/
ELSE: /else(?![a-zA-Z0-9_])/
WHILE: /while(?![a-zA-Z0-9_])/
FOR: /for(?![a-zA-Z0-9_])/
IN: /in(?![a-zA-Z0-9_])/
RANGE: /range(?![a-zA-Z0-9_])/

FN: /fn(?![a-zA-Z0-9_])/
RET: /ret(?![a-zA-Z0-9_])/

TRY: /try(?![a-zA-Z0-9_])/
FAIL: /fail(?![a-zA-Z0-9_])/
ALWAYS: /always(?![a-zA-Z0-9_])/

TODO: /todo(?![a-zA-Z0-9_])/

INT: /int(?![a-zA-Z0-9_])/
FLOAT: /float(?![a-zA-Z0-9_])/

CLOSE: /close(?![a-zA-Z0-9_])/

NOT: "!"

FLOORDIV: "//"
POW: "**"

EQ_EQ: "=="
NOT_EQ: "!="
GT: ">"
LT: "<"
GE: ">="
LE: "<="

ID: /(?!(and|or|true|false|read|show|if|elif|else|while|for|in|range|fn|ret|try|fail|always|todo|int|float|close)\b)[a-zA-Z_][a-zA-Z0-9_]*/
INT_LITERAL: /~?[0-9]+/
FLOAT_LITERAL: /~?[0-9]+\.[0-9]+/
STR_LITERAL: /'([^'\\]|\\.)*'/

M_COMMENT: /(?s)###.*?###/
S_COMMENT: /#[^\n]*/

%ignore M_COMMENT
%ignore S_COMMENT

%ignore /[ \t\r\n]+/